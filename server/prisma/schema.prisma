// server/prisma/schema.prisma

// This is your Prisma schema file.
// Learn more about it in the docs: https://pris.ly/d/prisma-schema


generator client {
  provider                  = "prisma-client-py"
  enable_experimental_decimal = true
  binaryTargets             = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PageType {
  SUBSECTION
  ARTICLE
}

model Page {
  id                 Int      @id @default(autoincrement())
  confluenceId       String   @unique
  title              String
  slug               String   @unique
  description        String
  pageType           PageType
  parentConfluenceId String?
  authorName         String?
  views              Int      @default(0)
  updatedAt          DateTime

  // --- Relationships ---
  tags       Tag[]
  submission ArticleSubmission?

  // NEW: Back-relation to the Group that manages this page branch.
  // This will be null for most pages.
  managingGroup Group?

  @@index([parentConfluenceId])
}

model Tag {
  id    Int    @id @default(autoincrement())
  name  String @unique
  slug  String @unique
  pages Page[]
}

// MODIFIED: User model to add a many-to-many relationship with Group
model User {
  id              Int      @id @default(autoincrement())
  username        String   @unique
  name            String
  hashed_password String
  role            String   // 'MEMBER' or 'ADMIN'
  createdAt       DateTime @default(now())

  submissions ArticleSubmission[]
  notifications Notification[]

  // NEW: Many-to-many relationship with Group
  groups Group[]
}

// NEW: Model for permission groups
model Group {
  id   Int    @id @default(autoincrement())
  name String @unique

  // Many-to-many relationship with User
  members User[]

  // One-to-one: A group manages one specific page and its children
  managedPage   Page? @relation(fields: [managedPageId], references: [id])
  managedPageId Int?  @unique // A group can only manage one page root
}

model ArticleSubmission {
  id               Int      @id @default(autoincrement())
  confluencePageId String   @unique
  title            String
  status           String   // e.g., "PENDING_REVIEW", "REJECTED", "PUBLISHED"
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  author   User @relation(fields: [authorId], references: [id])
  authorId Int
  page Page @relation(fields: [confluencePageId], references: [confluenceId])
}

model Notification {
  id          Int      @id @default(autoincrement())
  message     String
  link        String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  recipient   User     @relation(fields: [recipientId], references: [id])
  recipientId Int
}
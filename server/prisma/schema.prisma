// server/prisma/schema.prisma

// This is your Prisma schema file.
// Learn more about it in the docs: https://pris.ly/d/prisma-schema


generator client {
  provider                  = "prisma-client-py"
  enable_experimental_decimal = true
  binaryTargets             = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum to clearly define the type of a page.
// This helps in querying for only categories (SUBSECTION) or only articles (ARTICLE).
enum PageType {
  SUBSECTION
  ARTICLE
}

// The core model for our local metadata library.
// Every page in Confluence that is part of our knowledge hub will have a corresponding record here.
model Page {
  id                 Int      @id @default(autoincrement())
  confluenceId       String   @unique // The ID from Confluence, our source of truth link.
  title              String   // The title of the page.
  slug               String   @unique // A URL-friendly version of the title.
  description        String   // The new, manually written description for UI cards.
  pageType           PageType // Defines if this page is a category or a final article.
  parentConfluenceId String?  // The Confluence ID of the parent page. This is the sole field used to build the hierarchy.
  authorName         String?  // The name of the original author.
  views              Int      @default(0) // We can now track views locally.
  updatedAt          DateTime // The last modified date from Confluence.

  // --- Relationships ---
  // Establishes a many-to-many relationship with the Tag model.
  tags       Tag[]
  // Establishes a one-to-one relationship with the ArticleSubmission model.
  submission ArticleSubmission?

  // --- Index for faster parent-child lookups ---
  @@index([parentConfluenceId])
}

// Central table for all unique tags (labels) in our system.
model Tag {
  id    Int    @id @default(autoincrement())
  name  String @unique // The name of the tag, e.g., "getting-started".
  slug  String @unique // The URL-friendly version of the name.

  // Establishes the other side of the many-to-many relationship with Page.
  pages Page[]
}

model User {
  id              Int      @id @default(autoincrement())
  username        String   @unique
  name            String
  hashed_password String
  role            String   // 'MEMBER' or 'ADMIN'
  createdAt       DateTime @default(now())

  // Relation to the new ArticleSubmission table
  submissions ArticleSubmission[]
  notifications Notification[]
}

// MODIFIED: This table tracks the review workflow for a page.
model ArticleSubmission {
  id               Int      @id @default(autoincrement())
  confluencePageId String   @unique
  title            String
  status           String   // e.g., "PENDING_REVIEW", "REJECTED", "PUBLISHED"
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Establishes a many-to-one relationship with User
  author   User @relation(fields: [authorId], references: [id])
  authorId Int

  // This now creates a one-to-one link to the Page model.
  page Page @relation(fields: [confluencePageId], references: [confluenceId])
}

// This model remains unchanged for this step.
model Notification {
  id          Int      @id @default(autoincrement())
  message     String
  link        String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relation to the User who receives it
  recipient   User     @relation(fields: [recipientId], references: [id])
  recipientId Int
}
// server/prisma/schema.prisma

// This is your Prisma schema file.
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider                  = "prisma-client-py"
  enable_experimental_decimal = true
  binaryTargets             = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PageType {
  SUBSECTION
  ARTICLE
}

model Page {
  id                 Int      @id @default(autoincrement())
  confluenceId       String   @unique
  title              String
  slug               String   @unique
  description        String
  pageType           PageType
  parentConfluenceId String?
  authorName         String?
  views              Int      @default(0)
  updatedAt          DateTime

  tags          Tag[]
  submission    ArticleSubmission?
  managingGroup Group?

  @@index([parentConfluenceId])
}

// --- NEW MODEL: TagGroup ---
model TagGroup {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  order       Int     @default(0) // For ordering on the frontend form

  // One-to-many relationship with Tag
  tags Tag[]
}

// --- MODIFIED MODEL: Tag ---
model Tag {
  id    Int    @id @default(autoincrement())
  name  String @unique
  slug  String @unique
  pages Page[]

  // Every Tag now MUST belong to a TagGroup
  tagGroup   TagGroup @relation(fields: [tagGroupId], references: [id])
  tagGroupId Int
}

model User {
  id              Int      @id @default(autoincrement())
  username        String   @unique
  name            String
  hashed_password String
  role            String
  createdAt       DateTime @default(now())

  submissions   ArticleSubmission[]
  notifications Notification[]
  groups        Group[]
}

model Group {
  id   Int    @id @default(autoincrement())
  name String @unique

  members       User[]
  managedPage   Page? @relation(fields: [managedPageId], references: [id])
  managedPageId Int?  @unique
}

model ArticleSubmission {
  id                 Int      @id @default(autoincrement())
  confluencePageId   String   @unique
  title              String
  status             String
  rejectionComment   String?  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  author             User     @relation(fields: [authorId], references: [id])
  authorId           Int
  page               Page     @relation(fields: [confluencePageId], references: [confluenceId])
}


model Notification {
  id          Int      @id @default(autoincrement())
  message     String
  link        String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  recipient   User     @relation(fields: [recipientId], references: [id])
  recipientId Int
}